<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>pidoaqui.com | Pide en negocios cerca de ti</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <header class="topbar">
      <div class="container topbar-inner">
        <button class="menu-trigger" id="menuTrigger" type="button" aria-label="Abrir menú">
          ☰
        </button>
        <a class="brand" href="index.html">
          <img class="brand-logo" src="LogoPidoAqui1.PNG" alt="Logo pidoaqui" />
          <span class="brand-text">pido<span>aqui</span>.com</span>
        </a>
        <nav class="nav">
          <a class="nav-link active" href="index.html">Inicio</a>
          <a class="nav-link" href="registro.html">Registra tu tienda</a>
          <a class="nav-link" href="login.html">Acceder</a>
          <a class="nav-link" href="dashboard-demo.html">Demo panel</a>
        </nav>
      </div>
    </header>

    <div class="menu-backdrop" id="menuBackdrop" hidden></div>
    <aside class="side-menu" id="sideMenu" aria-hidden="true">
      <button class="side-close" id="closeMenu" type="button" aria-label="Cerrar menú">×</button>
      <a class="side-item side-item-strong" href="registro.html">Regístrate</a>
      <a class="side-item" href="login.html">Iniciar sesión</a>
      <a class="side-link" href="registro.html">Crear una cuenta de negocios</a>
      <a class="side-link" href="registro.html">Agrega tu tienda</a>
      <a class="side-link" href="registro.html">Regístrate para realizar entregas</a>
      <a class="side-link" href="dashboard-demo.html">Ver panel demo</a>

      <div class="app-callout">
        <img src="LogoPidoAqui.png" alt="App pidoaqui" class="app-logo" />
        <div>
          <p>Hay mucho más que te encantará en la futura app.</p>
          <a href="#" class="btn btn-outline">Próximamente App pidoaqui</a>
        </div>
      </div>
    </aside>

    <main>
      <section class="hero hero-home" id="homeEntry">
        <img
          class="hero-home-image"
          src="assets/frutasyverduras.png"
          alt="Frutas y verduras frescas"
        />
        <div class="hero-home-overlay">
          <div class="container hero-home-content">
            <h1>Entrega de pedidos cerca de ti</h1>

            <form class="home-search" id="homeSearchForm">
              <div class="address-wrap">
                <input
                  id="addressInput"
                  type="text"
                  autocomplete="off"
                  placeholder="Ingresa la dirección exacta de entrega"
                />
                <button
                  id="toggleMap"
                  class="map-open-icon"
                  type="button"
                  aria-label="Abrir mapa"
                  title="Abrir mapa"
                >
                  <img src="assets/logopa.png" alt="Abrir mapa" />
                </button>
                <ul class="address-suggestions" id="addressSuggestions" hidden></ul>
              </div>

              <select id="fulfillmentSelect" aria-label="Tipo de pedido">
                <option value="delivery">Enviar a domicilio</option>
                <option value="pickup">Pasar por producto en tienda</option>
              </select>

              <button class="btn btn-primary" type="submit">Buscar tienda</button>
            </form>

            <div class="hero-actions">
              <a class="nav-link" href="login.html">Iniciar sesión</a>
            </div>

            <p class="location-help" id="locationStatus">
              Permite ubicación para mejorar las sugerencias de direcciones cercanas.
            </p>

            <div class="map-panel" id="mapPanel" hidden>
              <div class="map-panel-head">
                <strong>Mapa de ubicación</strong>
                <div class="map-panel-actions">
                  <button id="useCurrentLocation" class="btn btn-outline" type="button">
                    Usar mi ubicación actual
                  </button>
                  <button id="closeMap" class="btn btn-outline" type="button">Cerrar mapa</button>
                </div>
              </div>
              <div class="map-stage">
                <div id="mapCanvas" class="map-frame" title="Mapa de ubicación"></div>
                <div class="map-center-pointer" aria-hidden="true">
                  <img src="assets/logopa.png" alt="Puntero de ubicación" />
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section class="market-shell" id="marketView" hidden>
        <div class="container">
          <div class="market-toolbar">
            <button class="market-chip" id="marketModeDelivery" type="button">Entrega a domicilio</button>
            <button class="market-chip" id="marketModePickup" type="button">Recolectar</button>
            <div class="market-chip market-chip-location" id="marketLocationDisplay">
              Ubicación pendiente
            </div>
            <button class="market-chip" id="changeLocationBtn" type="button">Cambiar ubicación</button>
          </div>

          <div class="quick-filter-row" id="quickFilterRow">
            <button class="market-chip" type="button" data-quick-filter="delivery_fee">
              Costo de envío
            </button>
            <button class="market-chip" type="button" data-quick-filter="under_30">
              Menos de 30 min
            </button>
            <button class="market-chip" type="button" data-quick-filter="rating">
              Mayor calificación
            </button>
            <button class="market-chip" type="button" data-quick-filter="default">
              Organizar
            </button>
          </div>

          <div class="market-layout">
            <aside class="market-sidebar">
              <button class="market-nav-item active" type="button" data-market-filter="all">Inicio</button>
              <button class="market-nav-item" type="button" data-market-filter="alimentos">Súper</button>
              <button class="market-nav-item" type="button" data-market-filter="conveniencia">Express</button>
              <button class="market-nav-item" type="button" data-market-filter="farmacias">Farmacia</button>
              <a class="market-nav-item" href="registro.html">Regístrate</a>
              <a class="market-nav-item" href="login.html">Iniciar sesión</a>
            </aside>

            <article class="market-main-card">
              <h2>¿Se te antoja? Pídelo.</h2>
              <p>Busca tiendas por categoría y selecciona productos cerca de tu ubicación.</p>
              <div class="hero-actions">
                <a class="btn btn-primary" href="#negocios">Ver tiendas</a>
                <button class="btn btn-outline" id="marketEditSearch" type="button">Editar búsqueda</button>
              </div>
            </article>
          </div>
        </div>
      </section>

      <section class="section" id="negocios">
        <div class="container">
          <h2>Categorías disponibles</h2>
          <div class="category-list" id="categoryFilters">
            <button class="category-pill active" type="button" data-filter="all">Todas</button>
            <button class="category-pill" type="button" data-filter="alimentos">Alimentos</button>
            <button class="category-pill" type="button" data-filter="fruterias">Fruterías</button>
            <button class="category-pill" type="button" data-filter="conveniencia">Tiendas de conveniencia</button>
            <button class="category-pill" type="button" data-filter="ferreterias">Ferreterías</button>
            <button class="category-pill" type="button" data-filter="farmacias">Farmacias</button>
            <button class="category-pill" type="button" data-filter="mascotas">Mascotas</button>
            <button class="category-pill" type="button" data-filter="licores">Licores</button>
          </div>
          <p class="results-count" id="resultsCount">Mostrando 0 negocios</p>
          <div
            class="results-progress"
            id="resultsProgress"
            role="progressbar"
            aria-label="Negocios mostrados"
            aria-valuemin="0"
            aria-valuemax="0"
            aria-valuenow="0"
          >
            <span class="results-progress-bar" id="resultsProgressBar"></span>
          </div>
          <p class="results-progress-text" id="resultsProgressText">0% mostrado</p>
          <div class="cards cards-business" id="businessCards">
            <article class="card" data-category="alimentos" data-minutes="24" data-rating="4.8" data-delivery-fee="10" data-default-order="1">
              <h3>Restaurantes</h3>
              <p>
                Comida rápida, almuerzos y menús especiales con cobertura local.
              </p>
            </article>
            <article class="card" data-category="fruterias" data-minutes="35" data-rating="4.9" data-delivery-fee="0" data-default-order="2">
              <h3>Fruterías</h3>
              <p>
                Frutas y verduras seleccionadas por comercios cercanos.
              </p>
            </article>
            <article class="card" data-category="conveniencia" data-minutes="18" data-rating="4.5" data-delivery-fee="12" data-default-order="3">
              <h3>Tiendas de conveniencia</h3>
              <p>Productos de uso diario con entregas ágiles y horario extendido.</p>
            </article>
            <article class="card" data-category="ferreterias" data-minutes="42" data-rating="4.7" data-delivery-fee="18" data-default-order="4">
              <h3>Ferreterías</h3>
              <p>Herramientas, repuestos y materiales para hogar y obra.</p>
            </article>
            <article class="card" data-category="farmacias" data-minutes="20" data-rating="4.9" data-delivery-fee="8" data-default-order="5">
              <h3>Farmacias</h3>
              <p>Medicamentos, cuidado personal y compras programadas.</p>
            </article>
            <article class="card" data-category="alimentos" data-minutes="28" data-rating="4.6" data-delivery-fee="5" data-default-order="6">
              <h3>Panaderías</h3>
              <p>
                Pan fresco, pastelería y antojos para cada momento del día.
              </p>
            </article>
          </div>
          <p class="empty-state" id="emptyState" hidden>
            Aún no hay negocios de esta categoría en la demo.
          </p>
        </div>
      </section>
    </main>

    <footer class="footer">
      <div class="container">
        pidoaqui.com · Maqueta de prueba para validación de experiencia del usuario final.
      </div>
    </footer>
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>

    <script>
      (function () {
        const menuTrigger = document.getElementById("menuTrigger");
        const sideMenu = document.getElementById("sideMenu");
        const menuBackdrop = document.getElementById("menuBackdrop");
        const closeMenu = document.getElementById("closeMenu");

        function openMenu() {
          if (!sideMenu || !menuBackdrop) return;
          sideMenu.classList.add("is-open");
          sideMenu.setAttribute("aria-hidden", "false");
          menuBackdrop.hidden = false;
        }

        function hideMenu() {
          if (!sideMenu || !menuBackdrop) return;
          sideMenu.classList.remove("is-open");
          sideMenu.setAttribute("aria-hidden", "true");
          menuBackdrop.hidden = true;
        }

        menuTrigger?.addEventListener("click", openMenu);
        closeMenu?.addEventListener("click", hideMenu);
        menuBackdrop?.addEventListener("click", hideMenu);

        const addressInput = document.getElementById("addressInput");
        const addressSuggestions = document.getElementById("addressSuggestions");
        const useCurrentLocationButton = document.getElementById("useCurrentLocation");
        const toggleMapButton = document.getElementById("toggleMap");
        const closeMapButton = document.getElementById("closeMap");
        const mapPanel = document.getElementById("mapPanel");
        const mapCanvas = document.getElementById("mapCanvas");
        const locationStatus = document.getElementById("locationStatus");
        const homeSearchForm = document.getElementById("homeSearchForm");
        const fulfillmentSelect = document.getElementById("fulfillmentSelect");
        const homeEntry = document.getElementById("homeEntry");
        const marketView = document.getElementById("marketView");
        const marketLocationDisplay = document.getElementById("marketLocationDisplay");
        const marketModeDelivery = document.getElementById("marketModeDelivery");
        const marketModePickup = document.getElementById("marketModePickup");
        const changeLocationButton = document.getElementById("changeLocationBtn");
        const marketEditSearch = document.getElementById("marketEditSearch");
        const marketFilterButtons = Array.from(document.querySelectorAll("[data-market-filter]"));
        const quickFilterButtons = Array.from(document.querySelectorAll("[data-quick-filter]"));

        const LAST_LOCATION_KEY = "pideaqui_last_location";
        const LAST_CATEGORY_KEY = "pideaqui_last_category";
        const LAST_QUICK_FILTER_KEY = "pideaqui_last_quick_filter";

        let userCoordinates = null;
        let debounceTimer = null;
        let mapInstance = null;
        let reverseLookupSequence = 0;

        function setLocationStatus(text) {
          if (locationStatus) {
            locationStatus.textContent = text;
          }
        }

        function getCurrentModeLabel() {
          return fulfillmentSelect?.value === "pickup"
            ? "Recolectar"
            : "Entrega a domicilio";
        }

        function setModeButtons(mode) {
          marketModeDelivery?.classList.toggle("active", mode !== "pickup");
          marketModePickup?.classList.toggle("active", mode === "pickup");
        }

        function updateMarketSummary() {
          const address = String(addressInput?.value || "").trim();
          if (marketLocationDisplay) {
            marketLocationDisplay.textContent = address || "Ubicación pendiente";
          }
          setModeButtons(fulfillmentSelect?.value || "delivery");
        }

        function showMarketView(show) {
          if (!marketView || !homeEntry) return;
          marketView.hidden = !show;
          homeEntry.hidden = show;
        }

        function saveLastLocation() {
          const address = String(addressInput?.value || "").trim();
          if (!address) return;

          const payload = {
            address,
            mode: fulfillmentSelect?.value || "delivery",
            latitude: userCoordinates?.latitude ?? null,
            longitude: userCoordinates?.longitude ?? null,
            savedAt: new Date().toISOString(),
          };

          localStorage.setItem(LAST_LOCATION_KEY, JSON.stringify(payload));
        }

        function loadLastLocation() {
          try {
            const raw = localStorage.getItem(LAST_LOCATION_KEY);
            if (!raw) return null;
            const parsed = JSON.parse(raw);
            if (!parsed || !parsed.address) return null;
            return parsed;
          } catch {
            return null;
          }
        }

        function saveLastCategory(filter) {
          if (!filter) return;
          localStorage.setItem(LAST_CATEGORY_KEY, filter);
        }

        function loadLastCategory() {
          return localStorage.getItem(LAST_CATEGORY_KEY) || "all";
        }

        function saveLastQuickFilter(filter) {
          if (!filter) return;
          localStorage.setItem(LAST_QUICK_FILTER_KEY, filter);
        }

        function loadLastQuickFilter() {
          return localStorage.getItem(LAST_QUICK_FILTER_KEY) || "default";
        }

        function setActiveMarketFilter(filter) {
          marketFilterButtons.forEach((item) => {
            item.classList.toggle("active", item.dataset.marketFilter === filter);
          });
        }

        function ensureInteractiveMap() {
          if (!mapCanvas || typeof window.L === "undefined") {
            return null;
          }

          if (mapInstance) {
            return mapInstance;
          }

          mapInstance = window.L.map(mapCanvas).setView([19.4326, -99.1332], 13);
          window.L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            maxZoom: 19,
            attribution: "&copy; OpenStreetMap contributors",
          }).addTo(mapInstance);

          mapInstance.on("movestart", function () {
            setLocationStatus("Actualizando dirección...");
          });

          mapInstance.on("moveend", async function () {
            const center = mapInstance.getCenter();
            const latitude = center.lat;
            const longitude = center.lng;
            userCoordinates = { latitude, longitude };

            await syncAddressFromCoordinates(
              latitude,
              longitude,
              "Ubicación ajustada desde el mapa. Dirección actualizada.",
              "Ubicación ajustada desde el mapa. Completa la dirección manualmente si es necesario."
            );
          });

          return mapInstance;
        }

        function setMapVisible(isVisible) {
          if (!mapPanel) return;
          mapPanel.hidden = !isVisible;
          if (isVisible) {
            const map = ensureInteractiveMap();
            map?.invalidateSize();
            if (userCoordinates) {
              map?.setView([userCoordinates.latitude, userCoordinates.longitude], 16);
            }
          }
        }

        function updateMapByCoordinates(latitude, longitude) {
          const map = ensureInteractiveMap();
          if (!map || typeof window.L === "undefined") return;

          userCoordinates = { latitude, longitude };
          map.setView([latitude, longitude], 16);
        }

        async function syncAddressFromCoordinates(latitude, longitude, okMessage, failMessage) {
          const requestId = ++reverseLookupSequence;

          try {
            const data = await reverseGeocode(latitude, longitude);
            if (requestId !== reverseLookupSequence) return;

            const displayName = data?.display_name;
            if (displayName && addressInput) {
              addressInput.value = displayName;
              saveLastLocation();
            }
            renderSuggestions([]);
            updateMarketSummary();
            setLocationStatus(okMessage);
          } catch {
            if (requestId !== reverseLookupSequence) return;
            setLocationStatus(failMessage);
          }
        }

        function renderSuggestions(items) {
          if (!addressSuggestions) return;
          addressSuggestions.innerHTML = "";

          if (!items.length) {
            addressSuggestions.hidden = true;
            return;
          }

          items.forEach((item) => {
            const li = document.createElement("li");
            const button = document.createElement("button");
            button.type = "button";
            button.textContent = item.display_name;
            button.addEventListener("click", () => {
              if (addressInput) {
                addressInput.value = item.display_name;
                addressSuggestions.hidden = true;
              }

              if (item.lat && item.lon) {
                const latitude = Number(item.lat);
                const longitude = Number(item.lon);
                if (!Number.isNaN(latitude) && !Number.isNaN(longitude)) {
                  userCoordinates = { latitude, longitude };
                  updateMapByCoordinates(latitude, longitude);
                  saveLastLocation();
                  updateMarketSummary();
                }
              }
            });
            li.appendChild(button);
            addressSuggestions.appendChild(li);
          });

          addressSuggestions.hidden = false;
        }

        async function reverseGeocode(latitude, longitude) {
          const response = await fetch(
            "https://nominatim.openstreetmap.org/reverse?format=jsonv2&addressdetails=1&zoom=18&lat=" +
              encodeURIComponent(latitude) +
              "&lon=" +
              encodeURIComponent(longitude)
          );
          if (!response.ok) return null;
          return response.json();
        }

        async function searchAddresses(query) {
          if (!query || query.length < 3) {
            renderSuggestions([]);
            return;
          }

          let url =
            "https://nominatim.openstreetmap.org/search?format=jsonv2&addressdetails=1&limit=6&q=" +
            encodeURIComponent(query);

          if (userCoordinates) {
            const delta = 0.09;
            const left = userCoordinates.longitude - delta;
            const right = userCoordinates.longitude + delta;
            const top = userCoordinates.latitude + delta;
            const bottom = userCoordinates.latitude - delta;
            url +=
              "&viewbox=" +
              [left, top, right, bottom].map((value) => encodeURIComponent(value)).join(",") +
              "&bounded=1";
          }

          try {
            const response = await fetch(url);
            if (!response.ok) {
              renderSuggestions([]);
              return;
            }
            const data = await response.json();
            renderSuggestions(Array.isArray(data) ? data : []);
          } catch {
            renderSuggestions([]);
          }
        }

        async function searchAddressSingle(query) {
          if (!query || query.length < 3) return null;

          let url =
            "https://nominatim.openstreetmap.org/search?format=jsonv2&addressdetails=1&limit=1&q=" +
            encodeURIComponent(query);

          if (userCoordinates) {
            const delta = 0.09;
            const left = userCoordinates.longitude - delta;
            const right = userCoordinates.longitude + delta;
            const top = userCoordinates.latitude + delta;
            const bottom = userCoordinates.latitude - delta;
            url +=
              "&viewbox=" +
              [left, top, right, bottom].map((value) => encodeURIComponent(value)).join(",") +
              "&bounded=1";
          }

          try {
            const response = await fetch(url);
            if (!response.ok) return null;
            const data = await response.json();
            return Array.isArray(data) && data.length ? data[0] : null;
          } catch {
            return null;
          }
        }

        if (addressInput) {
          addressInput.addEventListener("input", () => {
            clearTimeout(debounceTimer);
            const query = addressInput.value.trim();
            debounceTimer = setTimeout(() => searchAddresses(query), 280);
          });

          addressInput.addEventListener("blur", () => {
            setTimeout(() => {
              if (addressSuggestions) {
                addressSuggestions.hidden = true;
              }
            }, 150);
          });

          addressInput.addEventListener("focus", () => {
            if (addressSuggestions && addressSuggestions.children.length) {
              addressSuggestions.hidden = false;
            }
          });
        }

        async function detectLocation() {
          if (!navigator.geolocation) {
            setLocationStatus("Tu navegador no permite geolocalización. Puedes escribir tu dirección manualmente.");
            return;
          }

          setLocationStatus("Obteniendo ubicación exacta...");

          navigator.geolocation.getCurrentPosition(
            async (position) => {
              userCoordinates = {
                latitude: position.coords.latitude,
                longitude: position.coords.longitude,
              };

              try {
                const data = await reverseGeocode(userCoordinates.latitude, userCoordinates.longitude);
                const displayName = data?.display_name;
                if (displayName && addressInput) {
                  addressInput.value = displayName;
                }

                updateMapByCoordinates(userCoordinates.latitude, userCoordinates.longitude);
                saveLastLocation();
                updateMarketSummary();
                setLocationStatus("Ubicación detectada. Sugerencias ajustadas a tu zona real.");
              } catch {
                setLocationStatus("Ubicación detectada. Puedes completar la dirección exacta manualmente.");
              }
            },
            () => {
              setLocationStatus("No se pudo obtener tu ubicación exacta. Escribe tu dirección manualmente.");
            },
            {
              enableHighAccuracy: true,
              timeout: 10000,
              maximumAge: 300000,
            }
          );
        }

        useCurrentLocationButton?.addEventListener("click", detectLocation);

        fulfillmentSelect?.addEventListener("change", () => {
          saveLastLocation();
          updateMarketSummary();
        });

        marketModeDelivery?.addEventListener("click", () => {
          if (fulfillmentSelect) {
            fulfillmentSelect.value = "delivery";
          }
          saveLastLocation();
          updateMarketSummary();
        });

        marketModePickup?.addEventListener("click", () => {
          if (fulfillmentSelect) {
            fulfillmentSelect.value = "pickup";
          }
          saveLastLocation();
          updateMarketSummary();
        });

        changeLocationButton?.addEventListener("click", () => {
          showMarketView(false);
          setMapVisible(true);
          addressInput?.focus();
        });

        marketEditSearch?.addEventListener("click", () => {
          showMarketView(false);
          addressInput?.focus();
        });

        toggleMapButton?.addEventListener("click", async () => {
          if (!mapPanel) return;
          const willOpen = mapPanel.hidden;
          setMapVisible(willOpen);

          if (willOpen) {
            if (userCoordinates) {
              updateMapByCoordinates(userCoordinates.latitude, userCoordinates.longitude);
              return;
            }

            const currentAddress = String(addressInput?.value || "").trim();
            const match = await searchAddressSingle(currentAddress);
            if (match?.lat && match?.lon) {
              const latitude = Number(match.lat);
              const longitude = Number(match.lon);
              userCoordinates = { latitude, longitude };
              updateMapByCoordinates(latitude, longitude);
              return;
            }

            detectLocation();
          }
        });

        closeMapButton?.addEventListener("click", () => {
          setMapVisible(false);
        });

        detectLocation();

        const lastLocation = loadLastLocation();
        if (lastLocation) {
          if (addressInput) {
            addressInput.value = lastLocation.address;
          }
          if (fulfillmentSelect && (lastLocation.mode === "delivery" || lastLocation.mode === "pickup")) {
            fulfillmentSelect.value = lastLocation.mode;
          }
          if (typeof lastLocation.latitude === "number" && typeof lastLocation.longitude === "number") {
            userCoordinates = {
              latitude: lastLocation.latitude,
              longitude: lastLocation.longitude,
            };
          }

          updateMarketSummary();
          showMarketView(true);
          setLocationStatus("Usando tu última ubicación guardada.");
        } else {
          updateMarketSummary();
        }

        homeSearchForm?.addEventListener("submit", (event) => {
          event.preventDefault();
          const address = String(addressInput?.value || "").trim();
          if (!address) {
            setLocationStatus("Ingresa una dirección para buscar tiendas cercanas.");
            addressInput?.focus();
            return;
          }

          const mode = fulfillmentSelect?.value === "pickup"
            ? "Pasar por producto en tienda"
            : "Enviar a domicilio";

          setLocationStatus("Buscando tiendas para: " + mode + " · " + address);
          saveLastLocation();
          updateMarketSummary();
          showMarketView(true);

          searchAddressSingle(address).then((match) => {
            if (match?.lat && match?.lon) {
              userCoordinates = {
                latitude: Number(match.lat),
                longitude: Number(match.lon),
              };
              updateMapByCoordinates(userCoordinates.latitude, userCoordinates.longitude);
              saveLastLocation();
              setLocationStatus("Dirección ubicada en mapa. Ahora elige una tienda.");
            }
          });

          document.getElementById("negocios")?.scrollIntoView({ behavior: "smooth", block: "start" });
        });

        const filterButtons = Array.from(document.querySelectorAll("[data-filter]"));
        const businessCards = Array.from(document.querySelectorAll("#businessCards .card"));
        const businessCardsContainer = document.getElementById("businessCards");
        const emptyState = document.getElementById("emptyState");
        const resultsCount = document.getElementById("resultsCount");
        const resultsProgress = document.getElementById("resultsProgress");
        const resultsProgressBar = document.getElementById("resultsProgressBar");
        const resultsProgressText = document.getElementById("resultsProgressText");
        const businessSection = document.getElementById("negocios");
        const totalBusinesses = businessCards.length;

        if (
          !filterButtons.length ||
          !businessCards.length ||
          !emptyState ||
          !resultsCount ||
          !resultsProgress ||
          !resultsProgressBar ||
          !resultsProgressText ||
          !businessSection
        ) {
          return;
        }

        function applyFilter(filter, label) {
          let visibleCount = 0;

          businessCards.forEach((card) => {
            const category = card.dataset.category;
            const isVisible = filter === "all" || category === filter;
            if (isVisible) {
              card.classList.remove("is-hidden");
              card.classList.remove("is-animated");
              void card.offsetWidth;
              card.classList.add("is-animated");
              visibleCount += 1;
              return;
            }

            card.classList.remove("is-animated");
            card.classList.add("is-hidden");
          });

          emptyState.hidden = visibleCount > 0;

          const progress = totalBusinesses ? (visibleCount / totalBusinesses) * 100 : 0;
          const roundedProgress = Math.round(progress);
          resultsProgressBar.style.width = progress + "%";
          resultsProgressText.textContent = roundedProgress + "% mostrado";
          resultsProgress.setAttribute("aria-valuemax", String(totalBusinesses));
          resultsProgress.setAttribute("aria-valuenow", String(visibleCount));

          const noun = visibleCount === 1 ? "negocio" : "negocios";
          if (filter === "all") {
            resultsCount.textContent =
              "Mostrando " + visibleCount + " de " + totalBusinesses + " " + noun;
            return;
          }

          resultsCount.textContent =
            "Mostrando " +
            visibleCount +
            " de " +
            totalBusinesses +
            " " +
            noun +
            " en " +
            label;
        }

        function formatDeliveryFee(value) {
          const fee = Number(value || "0");
          if (Number.isNaN(fee) || fee <= 0) {
            return "Envío $0";
          }
          return "Envío $" + fee;
        }

        function decorateBusinessCards() {
          businessCards.forEach((card) => {
            card.querySelector(".card-meta")?.remove();

            const minutes = Number(card.dataset.minutes || "0");
            const rating = Number(card.dataset.rating || "0");
            const deliveryFee = card.dataset.deliveryFee || "0";

            const meta = document.createElement("div");
            meta.className = "card-meta";
            meta.innerHTML =
              '<span class="card-meta-item">' + minutes + ' min</span>' +
              '<span class="card-meta-item">' + formatDeliveryFee(deliveryFee) + '</span>' +
              '<span class="card-meta-item">' + rating.toFixed(1) + '★</span>';

            card.appendChild(meta);
          });
        }

        function sortCardsByQuickFilter(filter) {
          if (!businessCardsContainer) return;

          const sorted = [...businessCards];

          if (filter === "delivery_fee") {
            sorted.sort(
              (a, b) =>
                Number(a.dataset.deliveryFee || "0") - Number(b.dataset.deliveryFee || "0")
            );
          } else if (filter === "under_30") {
            sorted.sort((a, b) => {
              const aMinutes = Number(a.dataset.minutes || "999");
              const bMinutes = Number(b.dataset.minutes || "999");
              const aPriority = aMinutes <= 30 ? 0 : 1;
              const bPriority = bMinutes <= 30 ? 0 : 1;
              if (aPriority !== bPriority) return aPriority - bPriority;
              return aMinutes - bMinutes;
            });
          } else if (filter === "rating") {
            sorted.sort(
              (a, b) => Number(b.dataset.rating || "0") - Number(a.dataset.rating || "0")
            );
          } else {
            sorted.sort(
              (a, b) => Number(a.dataset.defaultOrder || "0") - Number(b.dataset.defaultOrder || "0")
            );
          }

          sorted.forEach((card) => businessCardsContainer.appendChild(card));
        }

        function activateQuickFilter(filter) {
          const selected = filter || "default";
          quickFilterButtons.forEach((button) => {
            button.classList.toggle("active", button.dataset.quickFilter === selected);
          });
          sortCardsByQuickFilter(selected);
          saveLastQuickFilter(selected);
        }

        function activateCategoryFilter(filter) {
          const selectedFilter = filter || "all";
          const selectedButton = filterButtons.find((button) => button.dataset.filter === selectedFilter);
          const fallbackButton = filterButtons.find((button) => button.dataset.filter === "all");
          const targetButton = selectedButton || fallbackButton;
          if (!targetButton) return;

          const selectedLabel = targetButton.textContent.trim();
          filterButtons.forEach((item) => item.classList.remove("active"));
          targetButton.classList.add("active");
          applyFilter(targetButton.dataset.filter, selectedLabel);
          saveLastCategory(targetButton.dataset.filter);
          setActiveMarketFilter(targetButton.dataset.filter);
        }

        filterButtons.forEach((button) => {
          button.addEventListener("click", function () {
            const selected = button.dataset.filter;
            activateCategoryFilter(selected);
            setActiveMarketFilter(selected);

            if (window.matchMedia("(max-width: 960px)").matches) {
              businessSection.scrollIntoView({
                behavior: "smooth",
                block: "start",
              });
            }
          });
        });

        marketFilterButtons.forEach((button) => {
          button.addEventListener("click", () => {
            const selected = button.dataset.marketFilter;
            activateCategoryFilter(selected);
            businessSection.scrollIntoView({ behavior: "smooth", block: "start" });
          });
        });

        quickFilterButtons.forEach((button) => {
          button.addEventListener("click", () => {
            activateQuickFilter(button.dataset.quickFilter);
            businessSection.scrollIntoView({ behavior: "smooth", block: "start" });
          });
        });

        decorateBusinessCards();
        activateCategoryFilter(loadLastCategory());
        activateQuickFilter(loadLastQuickFilter());
      })();
    </script>
  </body>
</html>
